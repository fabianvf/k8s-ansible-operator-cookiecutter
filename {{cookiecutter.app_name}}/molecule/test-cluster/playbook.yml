---

- name: Converge
  hosts: localhost
  connection: local
  vars:
    ansible_python_interpreter: '{{ "{{ ansible_playbook_python }}" }}'
    deploy_dir: '{{'{{ lookup("env", "MOLECULE_PROJECT_DIRECTORY") }}/deploy'}}'
    image_name: {{ cookiecutter.group }}/{{cookiecutter.app_name }}:testing
  tasks:
  - name: Create the {{ cookiecutter.group }}/{{ cookiecutter.version }}.{{ cookiecutter.kind }}
    k8s:
      namespace: '{{ '{{ namespace }}' }}'
      definition: "{{'{{'}} lookup('file', '/'.join([deploy_dir, 'crds/{{cookiecutter.group.split('.')[0]}}_{{cookiecutter.version}}_{{cookiecutter.kind|lower}}_cr.yaml'])) {{'}}'}}"

  - name: Get the newly created Custom Resource
    debug:
      msg: "{{'{{'}} lookup('k8s', group='{{cookiecutter.group}}', api_version='{{cookiecutter.version}}', kind='{{cookiecutter.kind}}', namespace=namespace, resource_name=cr.metadata.name) {{'}}'}}"
    vars:
      cr: "{{'{{'}} lookup('file', '/'.join([deploy_dir, 'crds/{{cookiecutter.group.split('.')[0]}}_{{cookiecutter.version}}_{{cookiecutter.kind|lower}}_cr.yaml'])) | from_yaml {{'}}'}}"

- import_playbook: '{{'{{ playbook_dir }}/../default/asserts.yml'}}'
